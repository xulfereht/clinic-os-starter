{
  "version": "1.0.0",
  "description": "Error patterns for Support Agent escalation guidance",
  "patterns": [
    {
      "id": "d1-constraint",
      "match": "SQLITE_CONSTRAINT",
      "category": "database",
      "severity": "medium",
      "suggestion": "This D1 database constraint error may require Support Agent help. Run: pnpm support \"D1 SQLITE_CONSTRAINT: {error_message}\"",
      "context_hints": ["Check for duplicate keys", "Review foreign key relationships", "Verify NOT NULL constraints"]
    },
    {
      "id": "d1-error",
      "match": "D1_ERROR",
      "category": "database",
      "severity": "high",
      "suggestion": "D1 database error detected. For schema or migration issues, try: pnpm support --deep \"D1 error: {error_message}\"",
      "context_hints": ["Check migration status", "Verify schema compatibility", "Review recent changes"]
    },
    {
      "id": "worker-cpu-timeout",
      "match": "Worker exceeded CPU time limit",
      "category": "cloudflare",
      "severity": "high",
      "suggestion": "Worker timeout often indicates inefficient queries or infinite loops. Ask Support Agent: pnpm support --deep \"Worker CPU timeout in {function_name}\"",
      "context_hints": ["Profile database queries", "Check for N+1 queries", "Review loop conditions"]
    },
    {
      "id": "worker-memory",
      "match": "Worker exceeded memory limit",
      "category": "cloudflare",
      "severity": "high",
      "suggestion": "Worker memory limit exceeded. This may indicate large data processing issues. Try: pnpm support --deep \"Worker memory limit: {context}\"",
      "context_hints": ["Stream large data instead of loading all", "Check for memory leaks", "Review data size"]
    },
    {
      "id": "kv-not-found",
      "match": "KV namespace .* not found",
      "category": "cloudflare",
      "severity": "medium",
      "suggestion": "KV binding missing. Check wrangler.toml or ask: pnpm support \"KV namespace configuration\"",
      "context_hints": ["Verify wrangler.toml bindings", "Check namespace ID", "Ensure KV is created in Cloudflare dashboard"]
    },
    {
      "id": "r2-error",
      "match": "R2Error|R2 bucket .* not found",
      "category": "cloudflare",
      "severity": "medium",
      "suggestion": "R2 storage error detected. Check bucket configuration: pnpm support \"R2 bucket configuration: {error}\"",
      "context_hints": ["Verify bucket name in wrangler.toml", "Check bucket exists", "Review CORS settings"]
    },
    {
      "id": "clinic-config",
      "match": "clinic_setup\\.yaml|clinic\\.json",
      "category": "configuration",
      "severity": "low",
      "suggestion": "For clinic configuration questions: pnpm support \"clinic_setup.yaml: {specific_issue}\"",
      "context_hints": ["Check YAML syntax", "Verify required fields", "Review example configurations"]
    },
    {
      "id": "hq-connection",
      "match": "Failed to fetch from HQ|HQ server .* unreachable",
      "category": "network",
      "severity": "medium",
      "suggestion": "HQ connection issue. Check network and credentials: pnpm support \"HQ connectivity: {error}\"",
      "context_hints": ["Verify device token", "Check network connectivity", "Review HQ URL in config"]
    },
    {
      "id": "auth-error",
      "match": "Invalid license|License expired|Unauthorized",
      "category": "authentication",
      "severity": "high",
      "suggestion": "Authentication error. Verify your license key status: pnpm support \"License/auth error: {error}\"",
      "context_hints": ["Check LICENSE_KEY in .env", "Verify license status in HQ", "Re-run setup if needed"]
    },
    {
      "id": "migration-error",
      "match": "Migration failed|Schema mismatch|database is locked",
      "category": "database",
      "severity": "high",
      "suggestion": "Database migration issue. This may require careful resolution: pnpm support --deep \"Migration error: {error_message}\"",
      "context_hints": ["Check d1_migrations table", "Verify migration order", "Stop other processes using DB"]
    },
    {
      "id": "durable-objects",
      "match": "Durable Object .* error|DO_ERROR",
      "category": "cloudflare",
      "severity": "high",
      "suggestion": "Durable Objects error detected. Ask for expert guidance: pnpm support --deep \"Durable Objects: {error}\"",
      "context_hints": ["Check DO class definitions", "Verify bindings", "Review state management"]
    },
    {
      "id": "git-sync-error",
      "match": "git .* failed|merge conflict|fetch.*error",
      "category": "git",
      "severity": "medium",
      "suggestion": "Git sync issue during core update. Try: pnpm support \"Git sync error: {error}\"",
      "context_hints": ["Check local modifications", "Try git stash", "Review conflict files"]
    }
  ],
  "escalation_rules": {
    "auto_suggest_after_attempts": 2,
    "deep_mode_categories": ["cloudflare", "database"],
    "always_deep_severity": ["high"]
  }
}
